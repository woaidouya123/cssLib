<!DOCTYPE html>

<head>
  <title>视频转文字</title>
  <style>
    #text{
      font-size: 12px;
      line-height: 12px;
      display: inline-block;
      vertical-align: top;
    }
    canvas{
      display: inline-block;
    }
  </style>
</head>

<body>
  <input type="file" accept="video/*" />
  <input type="submit" onClick="reloadRandomFrame()" value="load random frame" /><br />
  <canvas id="prevImgCanvas">Your browser does not support the HTML5 canvas tag.</canvas>
  <div id="text"></div>
  <script>
    var video = document.createElement("video");
    var textDiv = document.getElementById("text");
    var canvas = document.getElementById("prevImgCanvas");
    canvas.width = 720;
    canvas.height = 360;
    var time = 0, frameIndex = 0;
    var context = canvas.getContext('2d');

    const TICK = 10;
    const FRAME = 2;
    const TEXT = ["密","好","回","飞","口"];

    function calcText(light) {
      return TEXT[Math.floor(light/(256/TEXT.length))];
    }

    video.addEventListener('loadeddata', function () {
      // reloadRandomFrame();
      window.requestAnimationFrame(videoRun);
    }, false);

    video.addEventListener('seeked', function () {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      let temp = ""
      for (let i = 0; i < imageData.data.length -1; i += 4 * TICK) {
        var r = imageData.data[i]
        var g = imageData.data[i + 1]
        var b = imageData.data[i + 2]
        if(i % (4 * canvas.width) === 0){
          i > 0 && (temp += "<br/>");
          i += canvas.width * 4 * TICK;
        }else{
          temp += calcText((r + g + b) / 3)
        }
        
      }
      textDiv.innerHTML = temp;
    }, false);

    var playSelectedFile = function (event) {
      var file = this.files[0];
      var fileURL = URL.createObjectURL(file);
      video.src = fileURL;
    }

    var input = document.querySelector('input');
    input.addEventListener('change', playSelectedFile, false);

    function reloadRandomFrame() {
      if (!isNaN(video.duration)) {
        var rand = Math.round(Math.random() * video.duration * 1000) + 1;
        video.currentTime = rand / 1000;
      }
    }

    function videoRun() {
      time += 16.7;
      if(frameIndex >= FRAME){
        video.currentTime = (time / 1000 % video.duration);
        frameIndex = 0;
      }else  frameIndex++;
      window.requestAnimationFrame(videoRun);
    }

  </script>
</body>

</html>